```
backend/
|-- app/
|      |-- views/           # è§†å›¾
|          |-- __init__.py  # æµ‹è¯•æ–‡ä»¶
|          |-- admin.py     # è®¾å¤‡ç®¡ç†ç›¸å…³çš„è§†å›¾å‡½æ•°
|          |-- auth.py      # ç™»å½•å’Œæ³¨é”€çš„è§†å›¾å‡½æ•°
|          |-- client.py    # å¤„ç†æœ‰å…³å®¢æˆ·ç«¯
|          |-- control.py   # å¤„ç†å®¢æˆ·ç«¯æ§åˆ¶æ“ä½œ
|          |-- query.py     # æ•°æ®æŸ¥è¯¢ç›¸å…³çš„è§†å›¾å‡½æ•°
|          |-- room.py      # æˆ¿é—´ç›¸å…³çš„è§†å›¾å‡½æ•°
|      |-- config.py        # é…ç½®æ–‡ä»¶
|      |-- models.py        # æ•°æ®åº“æ¨¡å‹
|      |-- run.py           # æ„å»ºå®ä¾‹
|      |-- scheduler.py     # è°ƒåº¦é€»è¾‘
|      |-- utils.py         # è¾…åŠ©å‡½æ•°å’Œå·¥å…·å‡½æ•°
|-- data/
|      |-- buptse.db        # Sqlite æ•°æ®åº“
|      |-- Bupt.db          # Sqlite æ•°æ®åº“å¤‡ä»½
|      |-- buptse.sql       # SQL æ–‡ä»¶
|-- start_client.py         # è¿è¡Œæ–‡ä»¶
```
## åç«¯éƒ¨åˆ†äº¤äº’ä½¿ç”¨è¯´æ˜æ–‡æ¡£

> Written by @Conqueror712 ğŸ¤—

è¦æµ‹è¯•routeæ˜¯å¦å¯ç”¨ï¼Œä»¥ä¾¿è¿›è¡Œä¸‹ä¸€æ­¥çš„å¼€å‘ä¸ä½¿ç”¨ï¼Œè¯·ç¡®ä¿æ‹¥æœ‰ä»¥ä¸‹æµ‹è¯•ç¯å¢ƒï¼š

> æ³¨ï¼šå¹¶éä¸€å®šè¦ç”¨è¿™äº›ç¯å¢ƒæ‰èƒ½è¿›è¡Œæµ‹è¯•ï¼Œä»…ä¾›å‚è€ƒ

- OS: Windows 10/11
- APIæµ‹è¯•å·¥å…·: Apifox/Postman
- Pythonç¯å¢ƒ: requirements.txtä¸­æ‰€éœ€çš„æ‰€æœ‰ç¬¬ä¸‰æ–¹åº“
- Project src: git clone git@github.com:Cloud0310/BUPT-2023-SE-Homework.git
- DBMS: SQLite

### 1. æ‰“å¼€SQLiteå¹¶è¿æ¥æ•°æ®åº“

è¯·ç¡®ä¿ä½ æ­£ç¡®å®‰è£…äº†SQLiteå¹¶æ·»åŠ äº†ç›¸åº”çš„ç¯å¢ƒå˜é‡ï¼Œéšåæ‰“å¼€ä¸€ä¸ªPowerShellè¾“å…¥å‘½ä»¤ä»¥æ‰“å¼€SQLite:

```
sqlite3
```

å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•åˆ›å»ºä¸€ä¸ªæ•°æ®åº“ï¼ˆæ–¹æ³•ä¸å”¯ä¸€ï¼Œè¿™ç§æ–¹æ³•å¦‚æœ`xxx.db`å­˜åœ¨åˆ™ç›´æ¥ä¼šæ‰“å¼€ï¼Œä¸å­˜åœ¨å°±åˆ›å»ºå®ƒï¼‰:

```
sqlite>.open buptse.db
```      

> æ³¨æ„ï¼Œè¿™æ¡å‘½ä»¤å‰é¢çš„`sqlite>`ä¸éœ€è¦æˆ‘ä»¬è¾“å…¥ï¼Œå¦å¤–ï¼Œè¿™ä¼šåœ¨å½“å‰ç›®å½•ä¸‹åˆ›å»ºï¼Œè¯·ç¡®ä¿ä½ çš„è·¯å¾„æ­£ç¡®ï¼Œåœ¨æœ¬é¡¹ç›®ä¸­ï¼Œé»˜è®¤åœ¨ç›¸å¯¹è·¯å¾„`/backend/data/`ä¸‹

ä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æŒ‡ä»¤æ¥æŸ¥çœ‹æ˜¯å¦æˆåŠŸåˆ›å»ºï¼Œå½“ç„¶ä¹Ÿå¯ä»¥åœ¨æ–‡ä»¶å¤¹ä¸­ç›´æ¥æŸ¥çœ‹:

```
>sqlite>.databases
```

å¦å¤–ï¼Œå¦‚æœä½ å‘ç°ä½ çš„terminalä¸­çš„è¾“å‡ºå¹¶ä¸ç›´è§‚ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ¥å¼€å¯æ ¼å¼åŒ–è¾“å‡º:

```
sqlite>.header on
sqlite>.mode column
sqlite>.timer on
```

å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ¥æŸ¥çœ‹ä½ çš„SQLiteé…ç½®:

```
sqlite>.show
```

å¦‚æœä½ å€¦äº†ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ¥é€€å‡ºSQLiteï¼Œè¯·å°½é‡ä¸è¦æš´åŠ›é€€å‡º:

```
sqlite>.quit
```

å½“ä½ æƒ³å¯¼å‡ºå®Œæ•´çš„`.sql`æ–‡ä»¶çš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤:

```
sqlite3 xxx.db .dump > xxx.sql
```

å½“ç„¶ï¼Œä¹Ÿå¯ä»¥ç”±`.sql`æ¢å¤æˆ`.db`:

```
sqlite3 xxx.db < xxx.sql
```

> æ³¨ï¼šè¿™é‡Œå¯¼å‡ºçš„`.sql`æ–‡ä»¶çš„ç¼–ç æ ¼å¼ä¸ºASCII

```
sqlite>.tables
```

### 2. åˆ›å»ºè¡¨å‘½ä»¤ï¼ˆå¦‚æœæ˜¯ clone çš„ Repo åˆ™å¯ä»¥ç•¥è¿‡æ­¤æ­¥ï¼‰

ä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å¾—åˆ°è¡¨çš„å®Œæ•´ä¿¡æ¯:

```
sqlite>.schema table_name
```

![image](../backend/img/1.png)

> ä»¥ä¸‹æ˜¯åˆ›å»ºè¡¨çš„å‘½ä»¤ï¼Œå¦‚æœä½ æ˜¯ clone çš„åˆ™ä¸éœ€è¦åˆ›å»ºã€‚

```
sqlite> CREATE TABLE Users(
   username TEXT PRIMARY KEY NOT NULL,
   role TEXT NOT NULL
);

sqlite> CREATE TABLE Devices(
   room TEXT PRIMARY KEY NOT NULL,
   public_key TEXT NOT NULL
);

sqlite> CREATE TABLE RoomStatus(
   room TEXT PRIMARY KEY NOT NULL,
   temperature INT NOT NULL,
   wind_speed INT NOT NULL,
   mode TEXT NOT NULL,
   sweep BOOLEAN NOT NULL,
   is_on BOOLEAN NOT NULL,
   last_update TEXT NOT NULL
);

sqlite> CREATE TABLE Reports(
   room TEXT NOT NULL,
   start_time TEXT NOT NULL,
   end_time TEXT NOT NULL,
   temperature INT NOT NULL,
   wind_speed INT NOT NULL,
   mode TEXT NOT NULL,
   sweep BOOLEAN NOT NULL,
   duration INT NOT NULL,
   cost INT NOT NULL,
   PRIMARY KEY (room, start_time),
   FOREIGN KEY (room) REFERENCES RoomStatus(room)
);
```

### 3. å¯åŠ¨ Web Server

åˆ‡æ¢å› `backend` ç›®å½•ï¼Œä¿è¯ Sqlite è¿è¡Œçš„æƒ…å†µä¸‹ï¼Œè¾“å…¥ `python cli.py run` è¿è¡Œ

ä½ å¯ä»¥çœ‹åˆ° Server è¢«å¯åŠ¨ï¼Œå¯ä»¥ç‚¹å‡»è®¿é—®

![image](../backend/img/2.png)

æ¯”å¦‚ä½ å¯ä»¥è®¿é—® `http://127.0.0.1:11451/hello`

æˆ–è€…ä½ ä½¿ç”¨ç™»å½•åŠŸèƒ½ï¼Œè®¿é—® `http://127.0.0.1:11451/api/login`ï¼Œå‚æ•°åœ¨ Body é‡Œå†™è¿™æ ·çš„ json:

```
{
  "username": "admin",
  "password": "admin"
}
```

![image](../backend/img/3.png)

é€€å‡ºç™»å½•çš„è¯ï¼Œå°± `http://127.0.0.1:11451/api/logout`